---
title: "Introducción al análisis de secuencias NGS"
subtitle: 'Curso Genética y Genómica en Producción Animal'
author:
 name: Dr. José A. Gallardo, Dr(c) Margarita Rivera.
 affiliation: Pontificia Universidad Católica de Valparaíso
 email: <jose.gallardo@pucv.cl>
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
  word_document: default
  pdf_document: default
---

<style>
#TOC {
  color: black;
  font-familiy: Calibri;
  font-size: 14px;
  border-color: #708090; 
}
body {
   color: black;
   font-familiy: Calibri;
}

pre {
  color: black;
  background-color: #F8F8FF;
}
# header {
  color: #800000;
  font-familiy: Calibri;
  background-color: #F5F5F5;
  opacity: 0.8;
  font-size: 16px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

### INTRODUCCIÓN

Las tecnologías de secuenciación de próxima generación han evolucionado significativamente para proporcionar una mayor producción de datos (Taishan, Chitnis, Monos, & Dinh, 2021). Sin embargo, las plataformas son susceptibles a una amplia gama de fallas químicas e instrumentales (Stephan et al., 2014), por lo que, los datos obtenidos pueden tener un fuerte ruido de fondo, contaminación de los adaptadores, baja calidad de secuenciación, entre otros (He et al., 2020), lo que posteriormente representa problemas significativos en la precisión de la detección de variantes o regiones genómicas objetos de estudio. Por ello, el control de calidad, en el preprocesamiento de datos, se torna esencial, a fin de contar con datos limpios para evitar errores en análisis posteriores.

### FORMATO FASTQ

![**Figura 1. Estructura archivo fastq**](https://user-images.githubusercontent.com/80792310/120566231-6d598b00-c3d4-11eb-910e-b64df229eaf4.png)


El archivo fastq contiene las lecturas de secuenciación. Como se nota en la Figura 1, una lectura de secuenciación tiene 4 líneas, la primera representa el encabezado de la lectura, que inicia siempre con un @ y contiene datos informativos como, el número de serie del secuenciador y de carril, el swath que representa una región dentro del carril, las posiciones x e y dentro de cada swath y la dirección de las lecturas indicando una secuenciación pareada en este caso. 

Después del encabezado se tiene la secuencia de bases, el signo más y, las calidades, donde hay una correspondencia entre la base y su valor de calidad representado por un caracter alfanumérico ya sean números o letras codificados para un determinado Phred score.

Las secuencias deben tener sobre un QFRED mayor a 30

Quality score     0 ... 10 ... 20 ... 30


Quality enconding ! ... +  ... 5  ... A

### SOFTWARES DE BIOINFORMÁTICA

**FastQC**

**Descripción**

Para efectuar el análisis de control de calidad se han desarrollado diversas herramientas bioinformáticas siendo una de las primeras y más populares el software **FastQC** [(Andrews, 2010)](http://www.bioinformatics.babraham.ac.uk/projects/fastqc/). Este sofitware es compatible con las principales plataformas de secuenciación, pero usada preferentemente con datos de secuenciación Illumina. 

La versión del FastQC empleada en este trabajo es la 0.11.9. Este software tiene como objetivo proporcionar un conjunto modular de análisis para conocer si los datos tienen algún problema que deba tener en cuenta antes de realizar un análisis adicional.  FastQC resume la calidad de lectura por posición, informa al usuario del contenido del adaptador en secuencias, sobre frecuencias de tetrámeros y muchos otros aspectos que uno esperaría obtener de los datos de secuencia sin procesar (Brown, Pirrung, & McCue, 2017).

**Trimmomatic**

**Descripción**

[Trimmomatic](http://www.usadellab.org/cms/?page=trimmomatic) es un software que permite filtrar y podar datos NGS desde secuenciadores Illumina. 

Es una herramienta de línea de comandos rápida y multiproceso que se puede utilizar para filtrar y recortar datos de Illumina (FASTQ), así como para eliminar adaptadores. Trabaja con archivos FASTQ utilizando puntuaciones de calidad phred + 33 o + 64, dependiendo de la tubería de Illumina utilizada (Bolger, Lohse & Usadel, 2014). En este trabajo se emplea la versión 0.39.

Un manual del uso del software se puede descargar [aquí](http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf)

### Objetivos del trabajo práctico

- Realizar un análisis integral de control de calidad de secuencias NGS con fastqc. 

- Filtrar y podar las secuencias con el software trimmomatic.

### Origen de las muestras

Las muestras para analizar provienen de la base de datos SRA del NCBI y corresponden lecturas crudas del salmón del Atlántico _Salmo salar_ en formato fastq, obtenidas por secuenciación de extremos emparejados con un secuenciador Illumina HiSeq2000.

### Etapas del análisis de control de calidad, filtrado y poda.

- Descargar secuencias NGS usando SRA toolkit.

- Comprobar integridad de descarga de archivos usando md5sum o similar.

- Realizar análisis de control de calidad.

- Realizar filtrado y poda de secuencias.

- Transferir archivos de control de calidad mediante protocolo FTP desde Servidor a Cliente.


### Actividades

### Actividad 1 - Conectar a servidor Pomeo

Conecte al servidor pomeo usando la siguiente dirección IP: **200.54.220.141** puerto 22.

Ese el software PuTTy y las claves de acceso dadas en la clase anterior.

### Actividad 2 - Configurar bioconda e instalación de software

Para configurar el canal bioconda se debe ejecutar el siguiente comando

    conda config --add channels bioconda
    
Para buscar software en bioconda antes de instalar ejecute el siguiente comando. Note que si escribe el nombre de forma errada no encontrará el software.

    conda search -c bioconda fast-qc
    
    conda search -c bioconda fastqc
    
    conda search -c bioconda trimmomatic
    
    
Para la instalación de los software proceda a ejecutar los siguientes comandos en la terminal:

    conda install -c bioconda fastqc

    conda install -c bioconda trimmomatic

Checa los software instalados con 

    conda list
    conda list fastqc
    conda list trimmomatic

Usando el comando **mkdir** cree un directorio llamado SRA_samples

    mkdir SRA_samples

Acceda a este directorio con el comando 

    cd SRA_samples 

### Actividad 3 - Descarga de biomuestra desde SRA

Para esta práctica se trabajará con la biomuestra **SRR2006763** proveniente de la cepa Aquagen de _Salmo salar_ y a partir de la que se obtendrán los dos archivos fastq, ya que los datos provienen de secuenciación pair-end.

Biomuestra 1:SRR2006763_1.fastq
Biomuestra 2:SRR2006763_2.fastq

Crear un archivo ejecutable (.sh) con nano denominado download.sh

    nano download.sh

Introducir y guardar la información del script como se detalla a continuación, cambiando en la segunda y tercera línea por su nombre de usuario. Note que el script solo tiene 4 líneas.

     #!/bin/bash
     #SBATCH -J prefetch_usuario
     /home2/usuario/sratoolkit.2.11.0-centos_linux64/bin/prefetch --max-size 100G SRR2006763 -O /home2/usuario/SRA_samples/
     /home2/usuario/sratoolkit.2.11.0-centos_linux64/bin/vdb-validate /home2/usuario/SRA_samples/SRR2006763/SRR2006763.sra

Este script contiene las instrucciones necesarias para la descarga de la secuencia con el comando **prefetch** que es parte del kit de herramientas de SRA y su función es descargar archivos de secuencia en formato SRA comprimido. Además, incluye un segundo comando llamado vdb-validate que realiza varios chequeos luego de la descarga para hacegurar que esta se ha desarrollado correctamente. La descarga y chequeo demorará alrededor de dos minutos.

Correr el script mediante el siguiente comando

     bash download.sh

Al finalizar la ejecución listar la carpeta SRA_samples para comprobar que se creó el directorio de la secuencia descargada con el nombre **SRR2006763** y, dentro de este directorio deberá haberse generado el archivo SRR2006763.sra

    ls -l -h 

Acceder a la carpeta **SRR2006763** y crear el siguiente script (nano fdump.sh) que permitirá obtener los archivos fastq de la muestra **SRR2006763**

     #!/bin/bash
     #SBATCH - J fdump_usuario
     /home2/usuario/sratoolkit.2.11.0-centos_linux64/bin/fasterq-dump /home2/usuario/SRA_samples/SRR2006763/*.sra -O /home2/usuario/SRA_samples/SRR2006763/
     
Correr el script mediante el siguiente comando

     bash fdump.sh
     
Al finalizar, además de extraer los archivos fastq debería indicarle el total de read leidos y escritos.

spots read      : 2,856,007
reads read      : 5,712,014
reads written   : 5,712,014

Biomuestra 1:SRR2006763_1.fastq
Biomuestra 2:SRR2006763_2.fastq

### Actividad 4- Comprobación de integridad de archivos

md5sum es un algoritmo empleado para evitar algún daño que pudo generarse por algún motivo durante el proceso de descarga 

Busque el código Md5 de las muestras y direccione la información a un archivo md5_samples, con el siguiente comando:
  
    md5sum SRR2006763_1.fastq SRR2006763_2.fastq > md5_samples
    
Verificar la salida generada

    cat md5_samples
 
Contendrá los valores md5 de las muestras como se describe a continuación
 
    dd0bdf8c722226ea34611941f2391774  SRR2006763_1.fastq
    1c63ca4a6e14de4f93f7621e3e990ec9  SRR2006763_2.fastq

Compruebe la integridad de ambas biomuestras usando md5sum o similar.

    md5sum -c md5_samples

El comando dará como resultado el siguiente mensaje 

    SRR2006763_1.fastq: La suma coincide
    SRR2006763_2.fastq: La suma coincide

Con lo que se comprueba la integridad de los archivos descargados.

### Actividad 5 - Análisis de control de calidad

Para el análisis de control de calidad de secuencias fastq que provienen de secuenciadores NGS, en el directorio SRR2006763 crear y correr el siguiente script (nano fastqc.sh)

      #!/bin/bash
      #SBATCH - J fastqc_usuario
      fastqc /home2/usuario/SRA_samples/SRR2006763/*.fastq

La salida resultante de la ejecución del script anterior serán dos archivos:

1. archivo HTML
2. archivo .zip

Transferir archivos mediante protocolo FTP desde Servidor a Cliente, puede usar cualquier cliente o la línea de comandos.

- Para Windows mediante Winscp u otro 

- Para MAC: se puede crear un directorio temporal para la descarga de archivos

      cd tmp
      mkdir download
      cd download
      scp usuario@200.54.220.141:/home2/usuario/SRA_samples/SRR2006763/*.html .
       
- Se solicitará el ingreso de su clave
 
- Se concluirá la descarga al computador local y se la puede revisar con `open .`

Adicionalmente, POMEO tiene instalado Rstudio server por lo que es posible acceder sus archivos directamente ingresando al servidor a traves del puerto 8787.

http://200.54.220.141:8787/

Ingrese su usuario y password y visualice sus directorios y archivos.

### Actividad 6 - Filtrado y poda

Entrar a la carpeta donde constan los archivos fastq (SRR2006763/) y ejecutar el siguiente script (nano trimm.sh)

    #!/bin/bash
    #SBATCH - J trimm_usuario
    trimmomatic PE SRR2006763_1.fastq SRR2006763_2.fastq -baseout SRR20067634_filtered.fastq.gz SLIDINGWINDOW:5:25 MINLEN:60

De la ejecución anterior, resultarán 4 archivos comprimidos como se detalla a continuación

    SRR20067634_filtered_1P.fastq.gz
    SRR20067634_filtered_1U.fastq.gz
    SRR20067634_filtered_2P.fastq.gz
    SRR20067634_filtered_2U.fastq.gz

Descomprimir los archivos con

    unzip SRR20067634_filtered_1P.fastq.gz

Volver a realizar un análisis de calidad de las muestras y comparar con el reporte de calidad inicial (en un script o directamente en la terminal)

    fastqc  *.fastq.gz


### REFERENCIAS

- Grüning, B., Dale, R., Sjödin, A. et al. Bioconda: sustainable and comprehensive software distribution for the life sciences. Nat Methods 15, 475–476 (2018). https://doi.org/10.1038/s41592-018-0046-7 
- Brown, J., Pirrung, M., & McCue, L. (2017). FQC Dashboard: integrates FastQC results into a web-based, interactive, and extensible FASTQ quality control tool. Bioinformatics, 3137–3139.
- Stephan, P., Dander, A., Fischer, M., Snajder, R., Sperk, M., Efremova, M., . . . Trajanoski, Z. (2014). A survey of tools for variant analysis of next-generation genome sequencing data. Briefings in Bioinformatics, 256-278.
- Taishan, H., Chitnis, N., Monos, D., & Dinh, A. (2021). Next-generation sequencing technologies: An overview. Human Immunology, 1-10.
- He, B., Shu, R., Yang, H., Lu, Q., Wang, W., Song, L., . . . Lang, J. (2020). Assessing the Impact of Data Preprocessing on Analyzing Next Generation Sequencing . Frontiers in Bioengineering and Biotechnology, 1-12 .
- Bolger AM, Lohse M, Usadel B. Trimmomatic: a flexible trimmer for Illumina sequence data. Bioinformatics. 2014;30(15):2114-2120. doi:10.1093/bioinformatics/btu170
